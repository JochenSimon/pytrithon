gadget (0,0):
  FileSelect("Pick Firefox Bookmark Backup",
             filetype="Firefox Bookmark Backup (*.json)",
             cols=6)
  gives: read:0; file:6
var 0 (2,0);
python (4,0):
  bookmarks = json.loads(read)
  content = json.dumps(bookmarks, indent=4)
  enable = True
  takes: read:0; file:6
  gives: content:1; enable:3
  writes: file:4; bookmarks:5
var 1 (6,0);
gadget (8,0): TextEdit(cols=6)
  takes: replace:1
module (0,-5):
  import string
  import json
  from random import choice
  from datetime import datetime
  from itertools import batched
  
  from PyQt5.QtCore import QSize
  
  window.quit_on_close = "local"
  window.sizeHint = lambda: QSize(800,800)
  window.setWindowTitle("Bookmark Chunker")
  
  def random_guid():
    return "".join(choice(string.ascii_letters + string.digits + "_-") for _ in range(12))
  
  def timestamp():
    return int(datetime.now().timestamp()*1000)*1000
  
  def aggregate(node, key):
    yield node[key]
    if "children" in node:
      for child in node["children"]:
        yield from aggregate(child, key)
  
  def find_next_id(node):
    return max(aggregate(node, "id")) + 1
  
  def find_guids(node):
    return set(aggregate(node, "guid"))
  
  def find_folder(node, title):
    if node["title"] == title:
      yield node
    if "children" in node:
      for child in node["children"]:
        yield from find_folder(child, title)
gadget (0,1): LineEdit(row=2, col=1, cols=5)
  writes: text:2
var 2 (2,1): ""
gadget (0,3): PushButton("Chunkify", enabled=False, cols=6)
  takes: enable:3
  gives: clicked:7
var 3 (2,2);
var 4 (4,2): ""
var 5 (6,2): {}
var 6 (2,-1);
flow 7 (2,3);
python (4,3):
  enable = False
  next_id = find_next_id(bookmarks)
  existing_guids = find_guids(bookmarks)
  for found in find_folder(bookmarks, target):
    marks = found["children"]
    found["children"] = []
    for i,batch in enumerate(batched(marks, 50)):
      batch = list(batch)
      for j,mark in enumerate(batch):
        mark["index"] = j
      while (guid := random_guid()) in existing_guids:
        pass
      existing_guids.add(guid)
      found["children"].append({
        "guid": guid,
        "title": f"(Part {i})",
        "index": i,
        "dateAdded": timestamp(),
        "lastModified": timestamp(),
        "id": next_id,
        "typeCode": 2,
        "type": "text/x-moz-place-container",
        "children": batch
      })
      next_id += 1
    stem, ext = file.rsplit(".", 1)
    outfile = stem + "-chunked." + ext
    with open(outfile, "w", encoding="utf-8") as f:
      f.write(json.dumps(bookmarks))
    result = json.dumps(bookmarks, indent=4)
  reads: file:4; bookmarks:5; target:2
  takes: 7
  gives: result:1; enable:3
gadget (-1,2): Label("Folder to chunkify:", align="right", row=2)
comment (3.9,-5):
  This Agent can be used to split up a bookmark folder inside a Firefox
  bookmarks backup file into chunks of 50 bookmarks. I created this Agent
  for the usecase of enabling me to open all bookmarks as tabs in steps
  without requiring too much system memory all at once.
